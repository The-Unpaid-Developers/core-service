name: Integration Tests

on:
    push:
        branches: ["main", "develop", "test/**"]
    pull_request:
        branches: ["main", "develop"]
    workflow_dispatch: # Allows manual triggering

permissions:
    contents: read
    issues: read
    checks: write
    pull-requests: write

jobs:
    integration-tests:
        name: Run Integration Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            # Add Docker Buildx setup for Testcontainers
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            # Ensure Docker daemon is accessible
            - name: Verify Docker
              run: docker info

            - name: Cache Maven packages
              uses: actions/cache@v4
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
                  restore-keys: ${{ runner.os }}-m2

            # Pre-pull MongoDB image to speed up tests
            - name: Pull MongoDB image
              run: docker pull mongo:7.0

            - name: Run integration tests
              env:
                  # Testcontainers environment variables
                  TESTCONTAINERS_RYUK_DISABLED: false
                  TESTCONTAINERS_CHECKS_DISABLE: false
              run: |
                  mvn clean test \
                    -Dtest="*IntegrationTest" \
                    -Dspring.profiles.active=test \
                    -Dtestcontainers.reuse.enable=false

            - name: Generate JaCoCo coverage report
              if: success() || failure()
              run: mvn jacoco:report

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always() # Always upload, even on failure
              with:
                  name: integration-test-results
                  path: |
                      target/surefire-reports/
                      target/site/jacoco/

            - name: Publish test report
              uses: dorny/test-reporter@v1
              if: success() || failure()
              with:
                  name: Integration Tests Report
                  path: target/surefire-reports/*.xml
                  reporter: java-junit
                  fail-on-error: true

            - name: Comment test results on PR
              uses: EnricoMi/publish-unit-test-result-action@v2
              if: always() && github.event_name == 'pull_request'
              with:
                  files: target/surefire-reports/*.xml
                  check_name: "Integration Test Results"
                  comment_title: "ðŸ§ª Integration Test Results"

            - name: Add coverage comment to PR
              uses: madrapps/jacoco-report@v1.6.1
              if: github.event_name == 'pull_request'
              with:
                  paths: target/site/jacoco/jacoco.xml
                  token: ${{ secrets.GITHUB_TOKEN }}
                  min-coverage-overall: 80
                  min-coverage-changed-files: 80
                  title: "ðŸ“Š Code Coverage Report"

            - name: Check coverage thresholds
              if: success() || failure()
              run: |
                  echo "âœ… Integration tests completed!"
                  echo "ðŸ“Š Coverage reports generated"
                  echo "ðŸ“ˆ Target: 80%+ overall coverage"

            # Cleanup Docker resources
            - name: Cleanup Docker
              if: always()
              run: docker system prune -af --volumes